(function(){var e=this,t=e.d3,n=e.crossfilter,r={version:"0.1.0"};(function(){"use strict";function i(e){return e.charAt(0).toUpperCase()+e.slice(1)}function s(e){var t=i(e);return function(e){return Object.prototype.toString.call(e)==="[object "+t+"]"}}function o(){return 0}function u(){return{}}function a(e,t){return(e?e+".":"")+t}function f(e,t){return d(t)?function(n){return t(n,e)}:function(n){var r=e(t);return r!==null?n[r]:null}}function l(e){return function(t){return t[e]}}var c={};r.addDriver=function(e,t){function n(e){this.options=e}var r=t.hasOwnProperty("constructor")?t.constructor:n;r.prototype=t,c[e]=r},r.source=function(r,s){function v(e){if(!b[e]){var t=y.dimension(f(E,e)),n=t.filter;t.filter=function(e){return n.call(t,e),t._value=e,S.filter.call(t),t},t._value=null,b[e]=t}return b[e]}if(!c[r])throw new Error("Source type '"+r+"' unknown");var m={},g=[],y=n(),b={},w=new c[r](s),E=w.indexFor.bind(w),S=t.dispatch("ready","change","filter"),x=1,T;return m.on=function(e,t){return S.on(e,t),m},m.filter=function(e){return g.push(f(E,e)),m},m.fetch=function(e){return w.fetch(function(t){var n=!y.size();y.add(g.reduce(function(e,t){return e.filter(t)},t)),n&&S.ready.call(m),S.change.call(m),e&&e.call(m)}),m},m.start=function(t){return m.stop(),T=e.setTimeout(function n(){m.fetch(function(){e.setTimeout(n,t)})},t),m},m.stop=function(){return T&&(T=e.clearTimeout(T)),m},m.metric=function(){function e(e){var t=p(k);return t.length?t.reduce(function(t,n){return t[k[n]]=e[n],t},{}):e}function n(e){var t=p(k),n=A.reduce(function(e,t){return t(e)},e);return t.length===1?n[t[0]]:n}function r(e){return function(t,n){return L.reduce(function(t,r){return t[r.field]=r[e](t[r.field],n),t},t||{})}}function s(e,t){return function(n){var r=h(arguments,1),i=a(n,t),s=d(r[0])?i:r.shift()||i;return k[i]=s,r.forEach(function(e){A.push(function(t){return t[s]=e(t[s]),t})}),e(n,i)}}function c(){return T.reduce(function(e){return e+1},function(e){return e-1},o,"count")}function g(e,t){var n=f(E,e);return T.reduce(function(e,t){return e+n(t)},function(e,t){return e-n(t)},o,t)}function b(e,t){var n=a(e,"total");return t in D()||(c(),g(e,n),A.unshift(function(e){return e[t]=e.count?e[n]/e.count:0,e})),T}function w(e,t){var n=f(E,e);return T.reduce(function(e,t){var r=n(t);return r in e?e[r]++:e[r]=1,e},function(e,t){var r=n(t);return r in e&&(e[r]--,e[r]||delete e[r]),e},u,t)}function S(e,t){var n=f(E,e),r=a(e,"distincts");return t in D()||(w(e,r),A.unshift(function(e){return e[t]=p(e[r]).length,e})),T}var T={},N,C,k={},L=[],A=[e],O=f(E,"_date"),M=r("add"),_=r("remove"),D=r("initial"),P=t.dispatch("ready","change");return T.on=function(e,t){return P.on(e,t),T},T.by=function(e){if(N)throw new Error("A metric can only be dimensioned once");return N=v(e),T},["hour","day","week","month"].forEach(function(e){var n="by"+i(e);T[n]=function(){return T.by(function(n){return t.time[e](O(n))})}}),T.byDate=function(e){return T.by(function(t){return e?e(O(t)):O(t)})},T.byDateFormat=function(e){var n=t.time.format(e);return T.by(function(e){return n(O(e))})},T.byDayOfWeek=function(e,t){return e=e===undefined||e,e?T.byDateFormat(t?"%a":"%A"):function(e){return O(e).getDay()}},T.byHourOfDay=function(){return T.by(function(e){return O(e).getHours()})},T.reduce=function(e,t,n,r){return r=r||"output",r in D()||L.push({add:e,remove:t,initial:n,field:r}),T},T.count=s(c),T.sum=s(g,"total"),T.average=s(b,"average"),T.distinct=s(w,"distincts"),T.distinctCount=s(S,"distinct_total"),T.dimension=function(){return N},T.filter=function(e){if(!N)throw new Error("A metric can only be filtered after being dimensioned");return e===undefined?N._value:N.filter.call(N,e)},T.group=function(){if(!C){C=N?N.group():y.groupAll(),L.length&&C.reduce(M,_,D);if(C.all){var e=C.all;C.all=function(){return e.call(C).map(function(e){return{key:e.key,value:n(e.value)}})}}else{var t=C.value;C.value=function(){return n(t.call(C))}}}return C},T.value=function(){var e=T.group();return e[e.value?"value":"all"]()},T.domain=function(){return N?T.group().all().map(l("key")):null},T.extract=function(e){return A.push(l(e)),T},T.transform=function(e){var t=h(arguments);return A=A.concat(t),T},m.on("change."+x,function(){P.change.call(T)}),m.on("ready."+x,function(){P.ready.call(T)}),m.on("filter."+x,function(e){(!N||e!==N)&&P.change.call(T)}),x++,T},m};var h=Function.prototype.call.bind(Array.prototype.slice),p=Object.keys,d=s("function"),v=s("object"),m=Array.isArray})(),r.addDriver("lytics",{fetch:function(t){var n=this,r=this.options,i=r.url||"//api.lytics.io",s=i+"/api/"+(r.clientId?r.clientId+"/":"")+r.query,o=r.data||{},u=[],a=document.createElement("script"),f="analyst_lytics_"+(new Date).getTime();u.push("callback="+f),Object.keys(o).forEach(function(e){u.push(e+"="+o[e])}),u.length&&(s+="?"+u.join("&"));var l=function(r){var i=[];if(r.meta){var s=r.meta.dimensions,o=r.meta.measures,u={};offset=1,s&&s.length>0?(s.forEach(function(e,t){u[e]=t}),offset=s.length):u._=0,o.forEach(function(e,t){u[e.As]=t+offset}),u._ts=offset+o.length,u._date=u._ts+1,n.fields=u}r.data&&r.data.forEach(function(e){var t=e._ts,n=new Date(t.ts*1e3);e.rows.forEach(function(e,r){e.push(t.ts),e.push(n),i.push(e)})}),t(i),delete e[f],a.remove()};a.src=s,e[f]=l,document.body.appendChild(a)},indexFor:function(e){var t=this.fields;return t&&e in t?t[e]:null}}),typeof exports!="undefined"?exports.analyst=r:typeof define=="function"&&define.amd?define("analyst",function(){return r}):e.analyst=r})();