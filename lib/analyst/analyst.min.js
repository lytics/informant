(function(){function e(e){return e.charAt(0).toUpperCase()+e.slice(1)}function t(t){var n=e(t);return function(e){return Object.prototype.toString.call(e)==="[object "+n+"]"}}function n(){return 0}function r(){return{}}function i(e,t){return(e?e+".":"")+t}function s(e,t){return m(t)?function(n){return t(n,e)}:function(n){var r=e(t);return r!==null?n[r]:null}}function o(e){return function(t){return t[e]}}function u(e){var t={};e.on=function(n,r,i){var s,o,u,a;if(!r)return e;n=n.split(b);while(s=n.shift())a=t[s],o=a?a.tail:{},o.next=u={},o.context=i,o.callback=r,t[s]={tail:u,next:a?a.next:o};return e},e.off=function(n,r,i){var s,o,u,a,f;if(!(n||r||i))return t={},e;n=n?n.split(b):_.keys(t);while(s=n.shift()){o=t[s],delete t[s];if(!o||!r&&!i)continue;u=o.tail;while((o=o.next)!==u)a=o.callback,f=o.context,(r&&a!==r||i&&f!==i)&&e.on(s,a,f)}return e},e.trigger=function(n){var r,i,s,o,u,a;u=t.all,n=n.split(b),a=[].slice.call(arguments,1);while(r=n.shift()){if(i=t[r]){s=i.tail;while((i=i.next)!==s)i.callback.apply(i.context||e,a)}if(i=u){s=i.tail,o=[r].concat(a);while((i=i.next)!==s)i.callback.apply(i.context||e,o)}}return e}}var a=this,f=a.d3,l=a.crossfilter,c={version:"0.1.0"},h={};c.addDriver=function(e,t){if(c[e])throw new Error("Attempting to add a driver that already exists or is protected: '"+e+"'");return h[e]=t,c[e]=function(){var t=[e].concat(p(arguments));return c.source.apply(c,t)},c};var p=Function.prototype.call.bind(Array.prototype.slice),d=Object.keys,v=t("string"),m=t("function"),g=t("object"),y=Array.isArray,b=/\s+/;c.source=function(e){function t(e){return e in o?o[e]:null}if(!h[e])throw new Error("Source type '"+e+"' unknown");var n={},r=[],i,o={},f,d=l(),v={},b,w;return u(n),n.add=function(e){if(!y(e))throw new Error("Input data must be an array");var r=!d.size(),s;return i&&(e=e.reduce(function(e,n){return(s=i(n,f||t))&&e.push(s),e},[])),d.add(e),r&&n.trigger("ready"),n.trigger("change"),n},n.sanitizer=function(e){if(!arguments.length)return filter;if(!m(e))throw new Error("Sanitizer must be a function");return i=e,n},n.fieldMap=function(e){if(!arguments.length)return o;if(!g(e))throw new Error("Field map must be a plain object");return o=e,n},n.indexer=function(e){if(!arguments.length)return f||t;if(!m(e))throw new Error("Indexer must be a function");return f=e,n},n.fetch=function(){return m(b)&&b(),n},n.start=function(e){return n.stop(),w=a.setTimeout(function t(){n.fetch(function(){a.setTimeout(t,e)})},e),n},n.stop=function(){return w&&(w=a.clearTimeout(w)),n},n.metric=function(){return c.metric(n)},n.crossfilter=function(){return d},n.dimension=function(e){if(!v[e]){var t=d.dimension(s(n.indexer(),e)),r=t.filter;t.filter=function(e){return r.call(t,e),t._value=e,n.trigger("filter",t,e),t},t._value=null,v[e]=t}return v[e]},b=h[e].apply(n,p(arguments,1)),n},c.metric=function(t){function a(e){var t=d(T);return t.length?t.reduce(function(t,n){return t[T[n]]=e[n],t},{}):e}function l(e){var t=d(T),n=C.reduce(function(e,t){return t(e)},e);return t.length===1?n[t[0]]:n}function c(e){return function(t,n){return N.reduce(function(t,r){return t[r.field]=r[e](t[r.field],n),t},t||{})}}function h(e,t){return function(n){var r=p(arguments,1),s=i(n,t),o=m(r[0])?s:r.shift()||s;return T[s]=o,r.forEach(function(e){C.push(function(t){return t[o]=e(t[o]),t})}),e(n,s)}}function v(){return E.reduce(function(e){return e+1},function(e){return e-1},n,"count")}function g(e,r){var i=s(t.indexer(),e);return E.reduce(function(e,t){return e+i(t)},function(e,t){return e-i(t)},n,r)}function y(e,t){var n=i(e,"total");return t in O()||(v(),g(e,n),C.unshift(function(e){return e[t]=e.count?e[n]/e.count:0,e})),E}function b(e,n){var i=s(t.indexer(),e);return E.reduce(function(e,t){var n=i(t);return n in e?e[n]++:e[n]=1,e},function(e,t){var n=i(t);return n in e&&(e[n]--,e[n]||delete e[n]),e},r,n)}function w(e,n){var r=s(t.indexer(),e),o=i(e,"distincts");return n in O()||(b(e,o),C.unshift(function(e){return e[n]=d(e[o]).length,e})),E}var E={},S,x,T={},N=[],C=[a],k=s(t.indexer(),"_date"),L=c("add"),A=c("remove"),O=c("initial");return u(E),E.by=function(e){if(S)throw new Error("A metric can only be dimensioned once");return S=t.dimension(e),E},["hour","day","week","month"].forEach(function(t){var n="by"+e(t);E[n]=function(){return E.by(function(e){return f.time[t](k(e))})}}),E.byDate=function(e){return E.by(function(t){return e?e(k(t)):k(t)})},E.byDateFormat=function(e){var t=f.time.format(e);return E.by(function(e){return t(k(e))})},E.byDayOfWeek=function(e,t){return e=e===undefined||e,e?E.byDateFormat(t?"%a":"%A"):function(e){return k(e).getDay()}},E.byHourOfDay=function(){return E.by(function(e){return k(e).getHours()})},E.reduce=function(e,t,n,r){return r=r||"output",r in O()||N.push({add:e,remove:t,initial:n,field:r}),E},E.count=h(v),E.sum=h(g,"total"),E.average=h(y,"average"),E.distinct=h(b,"distincts"),E.distinctCount=h(w,"distinct_total"),E.dimension=function(){return S},E.filter=function(e){if(!S)throw new Error("A metric can only be filtered after being dimensioned");return e===undefined?S._value:S.filter.call(S,e)},E.group=function(){if(!x){x=S?S.group():t.crossfilter().groupAll(),N.length&&x.reduce(L,A,O);if(x.all){var e=x.all;x.all=function(){return e.call(x).map(function(e){return{key:e.key,value:l(e.value)}})}}else{var n=x.value;x.value=function(){return l(n.call(x))}}}return x},E.value=function(){var e=E.group();return e[e.value?"value":"all"]()},E.domain=function(){return S?E.group().all().map(o("key")):null},E.extract=function(e){return C.push(o(e)),E},E.transform=function(e){var t=p(arguments);return C=C.concat(t),E},["ready","change","filter"].forEach(function(e){t.on(e,function(){var t=[e].concat(p(arguments));E.trigger.apply(E,t)})}),t.on("filter",function(e,t){(!S||e!==S)&&E.trigger("change")}),E},c.addDriver("preload",function(e,t){g(t)&&this.fieldMap(t),this.add(y(e)?e:[])}),c.addDriver("lytics",function(e){var t=this;return e=e||{},function(n){var r=e.url||"//api.lytics.io",i=r+"/api/"+(e.clientId?e.clientId+"/":"")+e.query,s=e.data||{},o=[],u=document.createElement("script"),f="analyst_lytics_"+(new Date).getTime();o.push("callback="+f),Object.keys(s).forEach(function(e){o.push(e+"="+s[e])}),o.length&&(i+="?"+o.join("&"));var l=function(e){var n=[];if(e.meta){var r=e.meta.dimensions,i=e.meta.measures,s={};offset=1,r&&r.length>0?(r.forEach(function(e,t){s[e]=t}),offset=r.length):s._=0,i.forEach(function(e,t){s[e.As]=t+offset}),s._ts=offset+i.length,s._date=s._ts+1,t.fieldMap(s)}e.data&&e.data.forEach(function(e){var t=e._ts,r=new Date(t.ts*1e3);e.rows.forEach(function(e,i){e.push(t.ts),e.push(r),n.push(e)})}),t.add(n),delete a[f],u.remove()};u.src=i,a[f]=l,document.body.appendChild(u)}}),typeof exports!="undefined"?exports.analyst=c:typeof define=="function"&&define.amd?define("analyst",function(){return c}):a.analyst=c})();